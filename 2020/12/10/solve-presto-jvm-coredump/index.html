<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Presto Master JVM Core问题调研 - armsword&#39;blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="背景Presto master出现jvm coredump情况，排查问题，这里记录下排查过程。 排查过程先看下JVM Coredump日志： 123456789101112131415161718192021222324252627282930313233343536373839404142## There is insufficient memory for the Java Runtime E">
<meta property="og:type" content="article">
<meta property="og:title" content="Presto Master JVM Core问题调研">
<meta property="og:url" content="http://armsword.com/2020/12/10/solve-presto-jvm-coredump/index.html">
<meta property="og:site_name" content="armsword&#39;blog">
<meta property="og:description" content="背景Presto master出现jvm coredump情况，排查问题，这里记录下排查过程。 排查过程先看下JVM Coredump日志： 123456789101112131415161718192021222324252627282930313233343536373839404142## There is insufficient memory for the Java Runtime E">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-12-10T11:24:42.000Z">
<meta property="article:modified_time" content="2022-02-24T07:15:33.289Z">
<meta property="article:author" content="armsword">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
  <link href="/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">
  
<link rel="stylesheet" href="/css/style.css">

  

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-inner" class="inner">
      <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
      <a id="logo" class="logo" href="/"></a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://armsword.com"></form>
        </div>
      </nav>
    </div>
  </div>
</header>
    <section id="main" class="outer"><article id="post-solve-presto-jvm-coredump" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Presto Master JVM Core问题调研
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2020/12/10/solve-presto-jvm-coredump/" class="article-date">
  <time datetime="2020-12-10T11:24:42.000Z" itemprop="datePublished">2020-12-10</time>
</a>
      
    </div>

    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>Presto master出现jvm coredump情况，排查问题，这里记录下排查过程。</p>
<h2 id="排查过程"><a href="#排查过程" class="headerlink" title="排查过程"></a>排查过程</h2><p>先看下JVM Coredump日志：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># There is insufficient memory for the Java Runtime Environment to continue.</span></span><br><span class="line"><span class="comment"># Native memory allocation (mmap) failed to map 12288 bytes for committing reserved memory.</span></span><br><span class="line"><span class="comment"># Possible reasons:</span></span><br><span class="line"><span class="comment">#   The system is out of physical RAM or swap space</span></span><br><span class="line"><span class="comment">#   In 32 bit mode, the process size limit was hit</span></span><br><span class="line"><span class="comment"># Possible solutions:</span></span><br><span class="line"><span class="comment">#   Reduce memory load on the system</span></span><br><span class="line"><span class="comment">#   Increase physical memory or swap space</span></span><br><span class="line"><span class="comment">#   Check if swap backing store is full</span></span><br><span class="line"><span class="comment">#   Use 64 bit Java on a 64 bit OS</span></span><br><span class="line"><span class="comment">#   Decrease Java heap size (-Xmx/-Xms)</span></span><br><span class="line"><span class="comment">#   Decrease number of Java threads</span></span><br><span class="line"><span class="comment">#   Decrease Java thread stack sizes (-Xss)</span></span><br><span class="line"><span class="comment">#   Set larger code cache with -XX:ReservedCodeCacheSize=</span></span><br><span class="line"><span class="comment"># This output file may be truncated or incomplete.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  Out of Memory Error (os_linux.cpp:2640), pid=22120, tid=0x00007ef9d2ed3700</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># JRE version: Java(TM) SE Runtime Environment (8.0_144-b01) (build 1.8.0_144-b01)</span></span><br><span class="line"><span class="comment"># Java VM: Java HotSpot(TM) 64-Bit Server VM (25.144-b01 mixed mode linux-amd64 )</span></span><br><span class="line"><span class="comment"># Core dump written. Default location: /data1/cluster-data/core or core.22120 (max size 52428800 kB). To ensure a full core dump, try &quot;ulimit -c unlimited&quot; before starting Java again</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">---------------  T H R E A D  ---------------</span><br><span class="line"> </span><br><span class="line">Current thread (0x00007eff5eaf5000):  JavaThread <span class="string">&quot;IPC Client (1499102350) connection to presto-host.nmg01/data-node:8020 from user&quot;</span> daemon [_thread_new, <span class="attribute">id</span>=28463, stack(0x00007ef9d2e93000,0x00007ef9d2ed4000)]</span><br><span class="line"> </span><br><span class="line">Stack: [0x00007ef9d2e93000,0x00007ef9d2ed4000],  <span class="attribute">sp</span>=0x00007ef9d2ed2760,  free <span class="attribute">space</span>=253k</span><br><span class="line">Native frames: (<span class="attribute">J</span>=compiled Java code, <span class="attribute">j</span>=interpreted, <span class="attribute">Vv</span>=VM code, <span class="attribute">C</span>=native code)</span><br><span class="line">V  [libjvm.so+0xacb18a]  VMError::report_and_die()+0x2ba</span><br><span class="line">V  [libjvm.so+0x4ff4db]  report_vm_out_of_memory(char const*, int, unsigned long, VMErrorType, char const*)+0x8b</span><br><span class="line">V  [libjvm.so+0x927d23]  os::Linux::commit_memory_impl(char*, unsigned long, bool)+0x103</span><br><span class="line">V  [libjvm.so+0x927dec]  os::pd_commit_memory(char*, unsigned long, bool)+0xc</span><br><span class="line">V  [libjvm.so+0x9217ba]  os::commit_memory(char*, unsigned long, bool)+0x2a</span><br><span class="line">V  [libjvm.so+0x9261df]  os::pd_create_stack_guard_pages(char*, unsigned long)+0x7f</span><br><span class="line">V  [libjvm.so+0xa6ffce]  JavaThread::create_stack_guard_pages()+0x5e</span><br><span class="line">V  [libjvm.so+0xa797b4]  JavaThread::<span class="built_in">run</span>()+0x34</span><br><span class="line">V  [libjvm.so+0x92a338]  java_start(Thread*)+0x108</span><br><span class="line">C  [libpthread.so.0+0x7dc5]  start_thread+0xc5</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<span id="more"></span>

<p>可以看到报错是显示资源不足而导致JVM Coredump了。我们需要先看下是否是内存导致的问题：</p>
<p>所以先看下JVM日志，如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020-09-09T16:20:57.056</span><span class="string">+0800:</span> <span class="attr">501342.858:</span> [<span class="string">GC</span> <span class="string">pause</span> <span class="string">(G1</span> <span class="string">Evacuation</span> <span class="string">Pause)</span> <span class="string">(young)</span>, <span class="number">0.1361232</span> <span class="string">secs</span>]</span><br><span class="line">   [<span class="attr">Parallel Time:</span> <span class="number">116.8</span> <span class="string">ms</span>, <span class="attr">GC Workers:</span> <span class="number">28</span>]</span><br><span class="line">      [<span class="attr">GC Worker Start (ms): Min:</span> <span class="number">501342860.5</span>, <span class="attr">Avg:</span> <span class="number">501342860.9</span>, <span class="attr">Max:</span> <span class="number">501342861.4</span>, <span class="attr">Diff:</span> <span class="number">0.9</span>]</span><br><span class="line">      [<span class="attr">Ext Root Scanning (ms): Min:</span> <span class="number">2.3</span>, <span class="attr">Avg:</span> <span class="number">4.7</span>, <span class="attr">Max:</span> <span class="number">39.3</span>, <span class="attr">Diff:</span> <span class="number">36.9</span>, <span class="attr">Sum:</span> <span class="number">132.9</span>]</span><br><span class="line">      [<span class="attr">Update RS (ms): Min:</span> <span class="number">0.0</span>, <span class="attr">Avg:</span> <span class="number">6.2</span>, <span class="attr">Max:</span> <span class="number">8.4</span>, <span class="attr">Diff:</span> <span class="number">8.4</span>, <span class="attr">Sum:</span> <span class="number">173.4</span>]</span><br><span class="line">         [<span class="attr">Processed Buffers: Min:</span> <span class="number">0</span>, <span class="attr">Avg:</span> <span class="number">20.4</span>, <span class="attr">Max:</span> <span class="number">63</span>, <span class="attr">Diff:</span> <span class="number">63</span>, <span class="attr">Sum:</span> <span class="number">571</span>]</span><br><span class="line">      [<span class="attr">Scan RS (ms): Min:</span> <span class="number">0.0</span>, <span class="attr">Avg:</span> <span class="number">0.2</span>, <span class="attr">Max:</span> <span class="number">0.3</span>, <span class="attr">Diff:</span> <span class="number">0.3</span>, <span class="attr">Sum:</span> <span class="number">4.3</span>]</span><br><span class="line">      [<span class="attr">Code Root Scanning (ms): Min:</span> <span class="number">0.0</span>, <span class="attr">Avg:</span> <span class="number">0.0</span>, <span class="attr">Max:</span> <span class="number">0.1</span>, <span class="attr">Diff:</span> <span class="number">0.1</span>, <span class="attr">Sum:</span> <span class="number">0.2</span>]</span><br><span class="line">      [<span class="attr">Object Copy (ms): Min:</span> <span class="number">77.0</span>, <span class="attr">Avg:</span> <span class="number">104.9</span>, <span class="attr">Max:</span> <span class="number">106.9</span>, <span class="attr">Diff:</span> <span class="number">29.9</span>, <span class="attr">Sum:</span> <span class="number">2937.9</span>]</span><br><span class="line">      [<span class="attr">Termination (ms): Min:</span> <span class="number">0.0</span>, <span class="attr">Avg:</span> <span class="number">0.0</span>, <span class="attr">Max:</span> <span class="number">0.0</span>, <span class="attr">Diff:</span> <span class="number">0.0</span>, <span class="attr">Sum:</span> <span class="number">0.2</span>]</span><br><span class="line">         [<span class="attr">Termination Attempts: Min:</span> <span class="number">1</span>, <span class="attr">Avg:</span> <span class="number">1.0</span>, <span class="attr">Max:</span> <span class="number">1</span>, <span class="attr">Diff:</span> <span class="number">0</span>, <span class="attr">Sum:</span> <span class="number">28</span>]</span><br><span class="line">      [<span class="attr">GC Worker Other (ms): Min:</span> <span class="number">0.0</span>, <span class="attr">Avg:</span> <span class="number">0.1</span>, <span class="attr">Max:</span> <span class="number">0.3</span>, <span class="attr">Diff:</span> <span class="number">0.2</span>, <span class="attr">Sum:</span> <span class="number">3.9</span>]</span><br><span class="line">      [<span class="attr">GC Worker Total (ms): Min:</span> <span class="number">115.6</span>, <span class="attr">Avg:</span> <span class="number">116.2</span>, <span class="attr">Max:</span> <span class="number">116.6</span>, <span class="attr">Diff:</span> <span class="number">1.0</span>, <span class="attr">Sum:</span> <span class="number">3252.8</span>]</span><br><span class="line">      [<span class="attr">GC Worker End (ms): Min:</span> <span class="number">501342977.0</span>, <span class="attr">Avg:</span> <span class="number">501342977.0</span>, <span class="attr">Max:</span> <span class="number">501342977.2</span>, <span class="attr">Diff:</span> <span class="number">0.2</span>]</span><br><span class="line">   [<span class="attr">Code Root Fixup:</span> <span class="number">0.2</span> <span class="string">ms</span>]</span><br><span class="line">   [<span class="attr">Code Root Purge:</span> <span class="number">0.0</span> <span class="string">ms</span>]</span><br><span class="line">   [<span class="attr">Clear CT:</span> <span class="number">2.1</span> <span class="string">ms</span>]</span><br><span class="line">   [<span class="attr">Other:</span> <span class="number">17.0</span> <span class="string">ms</span>]</span><br><span class="line">      [<span class="attr">Choose CSet:</span> <span class="number">0.0</span> <span class="string">ms</span>]</span><br><span class="line">      [<span class="attr">Ref Proc:</span> <span class="number">8.3</span> <span class="string">ms</span>]</span><br><span class="line">      [<span class="attr">Ref Enq:</span> <span class="number">1.2</span> <span class="string">ms</span>]</span><br><span class="line">      [<span class="attr">Redirty Cards:</span> <span class="number">0.4</span> <span class="string">ms</span>]</span><br><span class="line">      [<span class="attr">Humongous Register:</span> <span class="number">0.2</span> <span class="string">ms</span>]</span><br><span class="line">      [<span class="attr">Humongous Reclaim:</span> <span class="number">0.0</span> <span class="string">ms</span>]</span><br><span class="line">      [<span class="attr">Free CSet:</span> <span class="number">2.7</span> <span class="string">ms</span>]</span><br><span class="line">   [<span class="attr">Eden:</span> <span class="number">27.</span><span class="string">0G(27.0G)-&gt;0.0B(24.7G)</span> <span class="attr">Survivors:</span> <span class="number">384.</span><span class="string">0M-&gt;768.0M</span> <span class="attr">Heap:</span> <span class="number">39.</span><span class="string">2G(64.0G)-&gt;12.6G(64.0G)</span>]</span><br><span class="line"> [<span class="attr">Times:</span> <span class="string">user=1.75</span> <span class="string">sys=1.55</span>, <span class="string">real=0.14</span> <span class="string">secs</span>]</span><br></pre></td></tr></table></figure>
<p>可以看到GC日志是正常的，young gc后，内存占用8G左右。</p>
<p>之前写脚本统计下内存占用，查看了&#x2F;proc&#x2F;meminfo信息:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">MemTotal:</span>       <span class="number">131779324</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">MemFree:</span>        <span class="number">28158200</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">MemAvailable:</span>   <span class="number">54607180</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">Buffers:</span>          <span class="number">229940</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">Cached:</span>         <span class="number">29816108</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">SwapCached:</span>            <span class="number">0</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">Active:</span>         <span class="number">94592988</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">Inactive:</span>        <span class="number">6479088</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">Active(anon):</span>   <span class="number">73867112</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">Inactive(anon):</span>  <span class="number">1373984</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">Active(file):</span>   <span class="number">20725876</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">Inactive(file):</span>  <span class="number">5105104</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">Unevictable:</span>           <span class="number">0</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">Mlocked:</span>               <span class="number">0</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">SwapTotal:</span>             <span class="number">0</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">SwapFree:</span>              <span class="number">0</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">Dirty:</span>               <span class="number">388</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">Writeback:</span>             <span class="number">0</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">AnonPages:</span>      <span class="number">71026488</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">Mapped:</span>           <span class="number">232460</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">Shmem:</span>           <span class="number">4215064</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">Slab:</span>            <span class="number">1416472</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">SReclaimable:</span>    <span class="number">1244120</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">SUnreclaim:</span>       <span class="number">172352</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">KernelStack:</span>       <span class="number">28192</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">PageTables:</span>       <span class="number">188212</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">NFS_Unstable:</span>          <span class="number">0</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">Bounce:</span>                <span class="number">0</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">WritebackTmp:</span>          <span class="number">0</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">CommitLimit:</span>    <span class="number">65889660</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">Committed_AS:</span>   <span class="number">118328976</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">VmallocTotal:</span>   <span class="number">34359738367</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">VmallocUsed:</span>      <span class="number">500096</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">VmallocChunk:</span>   <span class="number">34291843068</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">HardwareCorrupted:</span>     <span class="number">0</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">AnonHugePages:</span>      <span class="number">4096 </span><span class="string">kB</span></span><br><span class="line"><span class="attr">HugePages_Total:</span>       <span class="number">0</span></span><br><span class="line"><span class="attr">HugePages_Free:</span>        <span class="number">0</span></span><br><span class="line"><span class="attr">HugePages_Rsvd:</span>        <span class="number">0</span></span><br><span class="line"><span class="attr">HugePages_Surp:</span>        <span class="number">0</span></span><br><span class="line"><span class="attr">Hugepagesize:</span>       <span class="number">2048 </span><span class="string">kB</span></span><br><span class="line"><span class="attr">DirectMap4k:</span>      <span class="number">208476</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">DirectMap2M:</span>    <span class="number">17494016</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">DirectMap1G:</span>    <span class="number">118489088</span> <span class="string">kB</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到 MemAvailable 还有50+G内存，说明当时内存是充足的。不是内存不足导致的问题。那再需要确认下是否是线程数太多导致的问题？</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[presto@prestomaster00 <span class="keyword">cluster</span>-data]$ grep <span class="string">&quot;JavaThread&quot;</span> hs_err_pid22120.<span class="keyword">log</span> | wc -l</span><br><span class="line"><span class="number">30993</span></span><br></pre></td></tr></table></figure>
<p>线程数接近3.1W，有些多，去server.log里查找是否有线程创建失败的Log，命令：</p>
<p>grep -C 70 “unable to create new native thread” server.log.1 | less</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">java.io.<span class="type">IOException</span>: <span class="type">Failed</span> on local exception: java.io.<span class="type">IOException</span>: <span class="type">Couldn</span>&#x27;t <span class="keyword">set</span> up <span class="type">IO</span> streams; <span class="type">Host</span> <span class="type">Details</span> : local host <span class="keyword">is</span>: <span class="string">&quot;prestomaster00/xx.xx.xx.xx&quot;</span>; destination host <span class="keyword">is</span>: <span class="string">&quot;datanode&quot;</span>:<span class="number">8020</span>;</span><br><span class="line">        at org.apache.hadoop.net.<span class="type">NetUtils</span>.wrapException(<span class="type">NetUtils</span>.java:<span class="number">776</span>)</span><br><span class="line">        at org.apache.hadoop.ipc.<span class="type">Client</span>.call(<span class="type">Client</span>.java:<span class="number">1507</span>)</span><br><span class="line">        at org.apache.hadoop.ipc.<span class="type">Client</span>.call(<span class="type">Client</span>.java:<span class="number">1441</span>)</span><br><span class="line">        at org.apache.hadoop.ipc.<span class="type">ProtobufRpcEngine</span><span class="variable">$Invoker</span>.invoke(<span class="type">ProtobufRpcEngine</span>.java:<span class="number">229</span>)</span><br><span class="line">        at com.sun.proxy.<span class="variable">$Proxy218</span>.getListing(<span class="type">Unknown</span> <span class="type">Source</span>)</span><br><span class="line">        at org.apache.hadoop.hdfs.protocolPB.<span class="type">ClientNamenodeProtocolTranslatorPB</span>.getListing(<span class="type">ClientNamenodeProtocolTranslatorPB</span>.java:<span class="number">580</span>)</span><br><span class="line">        at sun.reflect.<span class="type">GeneratedMethodAccessor1052</span>.invoke(<span class="type">Unknown</span> <span class="type">Source</span>)</span><br><span class="line">        at sun.reflect.<span class="type">DelegatingMethodAccessorImpl</span>.invoke(<span class="type">DelegatingMethodAccessorImpl</span>.java:<span class="number">43</span>)</span><br><span class="line">        at java.lang.reflect.<span class="type">Method</span>.invoke(<span class="type">Method</span>.java:<span class="number">498</span>)</span><br><span class="line">        at org.apache.hadoop.io.retry.<span class="type">RetryInvocationHandler</span>.invokeMethod(<span class="type">RetryInvocationHandler</span>.java:<span class="number">253</span>)</span><br><span class="line">        at org.apache.hadoop.io.retry.<span class="type">RetryInvocationHandler</span>.invoke(<span class="type">RetryInvocationHandler</span>.java:<span class="number">101</span>)</span><br><span class="line">        at com.sun.proxy.<span class="variable">$Proxy219</span>.getListing(<span class="type">Unknown</span> <span class="type">Source</span>)</span><br><span class="line">        at org.apache.hadoop.hdfs.<span class="type">DFSClient</span>.listPaths(<span class="type">DFSClient</span>.java:<span class="number">2154</span>)</span><br><span class="line">        at org.apache.hadoop.hdfs.<span class="type">DistributedFileSystem</span><span class="variable">$DirListingIterator</span><span class="operator">.&lt;</span><span class="keyword">init</span><span class="operator">&gt;</span>(<span class="type">DistributedFileSystem</span>.java:<span class="number">1029</span>)</span><br><span class="line">        at org.apache.hadoop.hdfs.<span class="type">DistributedFileSystem</span><span class="variable">$DirListingIterator</span><span class="operator">.&lt;</span><span class="keyword">init</span><span class="operator">&gt;</span>(<span class="type">DistributedFileSystem</span>.java:<span class="number">1012</span>)</span><br><span class="line">        at org.apache.hadoop.hdfs.<span class="type">DistributedFileSystem</span><span class="variable">$20</span>.doCall(<span class="type">DistributedFileSystem</span>.java:<span class="number">957</span>)</span><br><span class="line">        at org.apache.hadoop.hdfs.<span class="type">DistributedFileSystem</span><span class="variable">$20</span>.doCall(<span class="type">DistributedFileSystem</span>.java:<span class="number">953</span>)</span><br><span class="line">        at org.apache.hadoop.fs.<span class="type">FileSystemLinkResolver</span>.resolve(<span class="type">FileSystemLinkResolver</span>.java:<span class="number">81</span>)</span><br><span class="line">        at org.apache.hadoop.hdfs.<span class="type">DistributedFileSystem</span>.listLocatedStatus(<span class="type">DistributedFileSystem</span>.java:<span class="number">971</span>)</span><br><span class="line">        at org.apache.hadoop.fs.<span class="type">FileSystem</span>.listLocatedStatus(<span class="type">FileSystem</span>.java:<span class="number">1771</span>)</span><br><span class="line">        at com.facebook.presto.hive.<span class="type">HadoopDirectoryLister</span>.list(<span class="type">HadoopDirectoryLister</span>.java:<span class="number">30</span>)</span><br><span class="line">        at com.facebook.presto.hive.util.<span class="type">HiveFileIterator</span><span class="variable">$FileStatusIterator</span><span class="operator">.&lt;</span><span class="keyword">init</span><span class="operator">&gt;</span>(<span class="type">HiveFileIterator</span>.java:<span class="number">130</span>)</span><br><span class="line">        at com.facebook.presto.hive.util.<span class="type">HiveFileIterator</span><span class="variable">$FileStatusIterator</span><span class="operator">.&lt;</span><span class="keyword">init</span><span class="operator">&gt;</span>(<span class="type">HiveFileIterator</span>.java:<span class="number">118</span>)</span><br><span class="line">        at com.facebook.presto.hive.util.<span class="type">HiveFileIterator</span>.getLocatedFileStatusRemoteIterator(<span class="type">HiveFileIterator</span>.java:<span class="number">107</span>)</span><br><span class="line">        at com.facebook.presto.hive.util.<span class="type">HiveFileIterator</span>.computeNext(<span class="type">HiveFileIterator</span>.java:<span class="number">100</span>)</span><br><span class="line">        at com.facebook.presto.hive.util.<span class="type">HiveFileIterator</span>.computeNext(<span class="type">HiveFileIterator</span>.java:<span class="number">37</span>)</span><br><span class="line">        at com.google.common.collect.<span class="type">AbstractIterator</span>.tryToComputeNext(<span class="type">AbstractIterator</span>.java:<span class="number">141</span>)</span><br><span class="line">        at com.google.common.collect.<span class="type">AbstractIterator</span>.hasNext(<span class="type">AbstractIterator</span>.java:<span class="number">136</span>)</span><br><span class="line">        at java.util.<span class="type">Spliterators</span><span class="variable">$IteratorSpliterator</span>.tryAdvance(<span class="type">Spliterators</span>.java:<span class="number">1811</span>)</span><br><span class="line">        at java.util.stream.<span class="type">StreamSpliterators</span><span class="variable">$WrappingSpliterator</span>.lambda<span class="variable">$initPartialTraversalState</span><span class="variable">$0</span>(<span class="type">StreamSpliterators</span>.java:<span class="number">294</span>)</span><br><span class="line">        at java.util.stream.<span class="type">StreamSpliterators</span><span class="variable">$AbstractWrappingSpliterator</span>.fillBuffer(<span class="type">StreamSpliterators</span>.java:<span class="number">206</span>)</span><br><span class="line">        at java.util.stream.<span class="type">StreamSpliterators</span><span class="variable">$AbstractWrappingSpliterator</span>.doAdvance(<span class="type">StreamSpliterators</span>.java:<span class="number">161</span>)</span><br><span class="line">        at java.util.stream.<span class="type">StreamSpliterators</span><span class="variable">$WrappingSpliterator</span>.tryAdvance(<span class="type">StreamSpliterators</span>.java:<span class="number">300</span>)</span><br><span class="line">        at java.util.<span class="type">Spliterators</span><span class="variable">$1</span>Adapter.hasNext(<span class="type">Spliterators</span>.java:<span class="number">681</span>)</span><br><span class="line">        at com.facebook.presto.hive.<span class="type">BackgroundHiveSplitLoader</span>.loadSplits(<span class="type">BackgroundHiveSplitLoader</span>.java:<span class="number">259</span>)</span><br><span class="line">        at com.facebook.presto.hive.<span class="type">BackgroundHiveSplitLoader</span>.access<span class="variable">$300</span>(<span class="type">BackgroundHiveSplitLoader</span>.java:<span class="number">91</span>)</span><br><span class="line">        at com.facebook.presto.hive.<span class="type">BackgroundHiveSplitLoader</span><span class="variable">$HiveSplitLoaderTask</span>.process(<span class="type">BackgroundHiveSplitLoader</span>.java:<span class="number">185</span>)</span><br><span class="line">        at com.facebook.presto.hive.util.<span class="type">ResumableTasks</span>.safeProcessTask(<span class="type">ResumableTasks</span>.java:<span class="number">47</span>)</span><br><span class="line">        at com.facebook.presto.hive.util.<span class="type">ResumableTasks</span>.access<span class="variable">$000</span>(<span class="type">ResumableTasks</span>.java:<span class="number">20</span>)</span><br><span class="line">        at com.facebook.presto.hive.util.<span class="type">ResumableTasks</span><span class="variable">$1</span>.run(<span class="type">ResumableTasks</span>.java:<span class="number">35</span>)</span><br><span class="line">        at io.airlift.concurrent.<span class="type">BoundedExecutor</span>.drainQueue(<span class="type">BoundedExecutor</span>.java:<span class="number">78</span>)</span><br><span class="line">        at java.util.concurrent.<span class="type">ThreadPoolExecutor</span>.runWorker(<span class="type">ThreadPoolExecutor</span>.java:<span class="number">1149</span>)</span><br><span class="line">        at java.util.concurrent.<span class="type">ThreadPoolExecutor</span><span class="variable">$Worker</span>.run(<span class="type">ThreadPoolExecutor</span>.java:<span class="number">624</span>)</span><br><span class="line">        at java.lang.<span class="type">Thread</span>.run(<span class="type">Thread</span>.java:<span class="number">748</span>)</span><br><span class="line"><span class="type">Caused</span> by: java.io.<span class="type">IOException</span>: <span class="type">Couldn</span>&#x27;t <span class="keyword">set</span> up <span class="type">IO</span> streams</span><br><span class="line">        at org.apache.hadoop.ipc.<span class="type">Client</span><span class="variable">$Connection</span>.setupIOstreams(<span class="type">Client</span>.java:<span class="number">822</span>)</span><br><span class="line">        at org.apache.hadoop.ipc.<span class="type">Client</span><span class="variable">$Connection</span>.access<span class="variable">$3000</span>(<span class="type">Client</span>.java:<span class="number">394</span>)</span><br><span class="line">        at org.apache.hadoop.ipc.<span class="type">Client</span>.getConnection(<span class="type">Client</span>.java:<span class="number">1556</span>)</span><br><span class="line">        at org.apache.hadoop.ipc.<span class="type">Client</span>.call(<span class="type">Client</span>.java:<span class="number">1480</span>)</span><br><span class="line">        <span class="operator">...</span> <span class="number">42</span> more</span><br><span class="line"><span class="type">Caused</span> by: java.lang.<span class="type">OutOfMemoryError</span>: unable to create new native thread</span><br><span class="line">        at java.lang.<span class="type">Thread</span>.start0(<span class="type">Native</span> <span class="type">Method</span>)</span><br><span class="line">        at java.lang.<span class="type">Thread</span>.start(<span class="type">Thread</span>.java:<span class="number">717</span>)</span><br><span class="line">        at org.apache.hadoop.ipc.<span class="type">Client</span><span class="variable">$Connection</span>.setupIOstreams(<span class="type">Client</span>.java:<span class="number">815</span>)</span><br><span class="line">        <span class="operator">...</span> <span class="number">45</span> more</span><br></pre></td></tr></table></figure>

<p>发现确实是无法创建线程，因为内存是充足的，说明是线程数太多导致的，那我们看下系统允许创建的线程数是多少？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[presto<span class="meta">@prestomaster00</span> log]$ ulimit -a</span><br><span class="line">core file <span class="title function_">size</span>          <span class="params">(blocks, -c)</span> <span class="number">52428800</span></span><br><span class="line">data seg <span class="title function_">size</span>           <span class="params">(kbytes, -d)</span> unlimited</span><br><span class="line">scheduling <span class="title function_">priority</span>             <span class="params">(-e)</span> <span class="number">0</span></span><br><span class="line">file <span class="title function_">size</span>               <span class="params">(blocks, -f)</span> unlimited</span><br><span class="line">pending <span class="title function_">signals</span>                 <span class="params">(-i)</span> <span class="number">600000</span></span><br><span class="line">max locked <span class="title function_">memory</span>       <span class="params">(kbytes, -l)</span> <span class="number">64</span></span><br><span class="line">max memory <span class="title function_">size</span>         <span class="params">(kbytes, -m)</span> unlimited</span><br><span class="line">open <span class="title function_">files</span>                      <span class="params">(-n)</span> <span class="number">1000000</span></span><br><span class="line">pipe <span class="title function_">size</span>            <span class="params">(<span class="number">512</span> bytes, -p)</span> <span class="number">8</span></span><br><span class="line">POSIX message <span class="title function_">queues</span>     <span class="params">(bytes, -q)</span> <span class="number">819200</span></span><br><span class="line">real-time <span class="title function_">priority</span>              <span class="params">(-r)</span> <span class="number">0</span></span><br><span class="line">stack <span class="title function_">size</span>              <span class="params">(kbytes, -s)</span> <span class="number">102400</span></span><br><span class="line">cpu <span class="title function_">time</span>               <span class="params">(seconds, -t)</span> unlimited</span><br><span class="line">max user <span class="title function_">processes</span>              <span class="params">(-u)</span> <span class="number">100000</span></span><br><span class="line">virtual <span class="title function_">memory</span>          <span class="params">(kbytes, -v)</span> unlimited</span><br><span class="line">file <span class="title function_">locks</span>                      <span class="params">(-x)</span> unlimited</span><br></pre></td></tr></table></figure>
<p>可以看到max user processes 是10W个，但是这个是系统限制某用户下最多可以运行多少进程或线程，这个值是表象，这个值是受全局的kernel.pid_max的值限制，那我们需要看下pid_max值：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[presto@prestomaster00 <span class="built_in">log</span>]$ <span class="built_in">cat</span>  /proc/sys/kernel/pid_max</span><br><span class="line">40960</span><br></pre></td></tr></table></figure>
<p>猜测超过了40960个进程，修改此值到10W，依然复现。</p>
<p>猜测线程数超过了JVM最大线程数，需要设置下JVM运行创建的线程数：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="string">&quot;200000&quot;</span> &gt; <span class="regexp">/proc/</span>sys<span class="regexp">/vm/m</span>ax_map_count</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>默认65530，永久修改在&#x2F;etc&#x2F;sysctl.conf。在其他资源可用的前提下，单个JVM能开启的最大线程数是&#x2F;proc&#x2F;sys&#x2F;vm&#x2F;max_map_count的设置数的一半。</p>
<p>修改后，发现JVM不再Coredump。</p>
<p>但是这个只是临时解决，帮助避免节点频发JVM Coredump，核心还是看下为啥会创建3W+线程。</p>

      
    </div>
    
      <div class="article-toc">
        <h3>目录</h3>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%92%E6%9F%A5%E8%BF%87%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">排查过程</span></a></li></ol>
      </div>
    
    
      <footer class="article-footer">
        
      </footer>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/12/30/slove-jit-deoptimization-and-es-insert-performance-improvement/" id="article-nav-newer" class="article-nav-link-wrap">
      <div class="article-nav-title"><span>&lt;</span>&nbsp;
        
          解决JIT Deoptimization，ES插入性能提升7倍
        
      </div>
    </a>
  
  
    <a href="/2020/11/03/presto-in-didichuxing/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Presto 在滴滴的探索和实践&nbsp;<span>&gt;</span></div>
    </a>
  
</nav>

  
</article>

</section>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2024 armsword&nbsp;
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, theme by <a href="http://github.com/ppoffice">PPOffice</a>
    </div>
  </div>
</footer>
    

<script src="/js/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>

  </div>
</body>
</html>